#!/usr/bin/env bash
#
# Duplicity Backup List Script
# Managed by Ansible - DO NOT EDIT MANUALLY
#

set -euo pipefail

readonly ENV_FILE="{{ _duplicity_env_file }}"
readonly DUPLICITY_BIN="{{ duplicity_binary }}"
readonly CACHE_DIR="{{ duplicity_cache_dir }}"
readonly DESTINATION="{{ duplicity_destination }}"

# Load environment variables
if [[ -f "$ENV_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$ENV_FILE"
fi

usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] [PATH]

List files in the backup archive.

Options:
  -t, --time TIME    List files at specific time (e.g., '2024-01-15', '3D')
  -h, --help         Show this help message

Arguments:
  PATH               Optional path pattern to filter (e.g., '/etc/nginx')

Examples:
  $(basename "$0")                      # List all files in latest backup
  $(basename "$0") /etc                 # List files under /etc
  $(basename "$0") --time 3D            # List files from 3 days ago
  $(basename "$0") --time 3D /var/www   # List /var/www from 3 days ago

EOF
}

# Build common options
build_opts() {
    local opts=""

{% if duplicity_encryption_method == 'none' %}
    opts+=" --no-encryption"
{% elif duplicity_encryption_method == 'gpg' and duplicity_gpg_key %}
    opts+=" --encrypt-key {{ duplicity_gpg_key }}"
{% endif %}

{% if _duplicity_detected_backend | trim == 's3' %}
{% if duplicity_s3_endpoint_url %}
    opts+=" --s3-endpoint-url {{ duplicity_s3_endpoint_url }}"
{% if duplicity_s3_endpoint_url.startswith('http://') %}
    opts+=" --s3-unencrypted-connection"
{% endif %}
{% endif %}
{% if duplicity_s3_region_name %}
    opts+=" --s3-region-name {{ duplicity_s3_region_name }}"
{% endif %}
{% endif %}

    opts+=" --archive-dir=$CACHE_DIR"

    echo "$opts"
}

main() {
    local opts
    opts=$(build_opts)

    local time_opt=""
    local path_filter=""

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -t|--time)
                time_opt="--time $2"
                shift 2
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                usage
                exit 1
                ;;
            *)
                path_filter="$1"
                shift
                ;;
        esac
    done

    echo "Backup File Listing"
    echo "==================="
    echo "Destination: $DESTINATION"
    [[ -n "$time_opt" ]] && echo "Time:        ${time_opt#--time }"
    [[ -n "$path_filter" ]] && echo "Filter:      $path_filter"
    echo ""

    # shellcheck disable=SC2086
    if [[ -n "$path_filter" ]]; then
        $DUPLICITY_BIN list-current-files $opts $time_opt "$DESTINATION" | grep -E "^$path_filter" || true
    else
        $DUPLICITY_BIN list-current-files $opts $time_opt "$DESTINATION"
    fi
}

main "$@"
